#!/usr/bin/env bash
#
# my-library-push - Push local my-prefixed items from ~/.claude/ to the Git repository
#
# Usage:
#   my-library-push                          Push all my-items
#   my-library-push --dry-run                Show what would change
#   my-library-push --message "custom msg"   Custom commit message
#   my-library-push --only-skills            Push only skills
#   my-library-push --verbose                Show detailed output
#
# Requires: git

set -euo pipefail

VERSION="1.0.0"
REPO_NAME="bpm-claude-global-agent-skill-library"
REPO_DIR="$HOME/$REPO_NAME"

# Defaults
DRY_RUN=0
VERBOSE=0
ONLY_SKILLS=0
ONLY_AGENTS=0
ONLY_COMMANDS=0
ONLY_RUNBOOKS=0
COMMIT_MSG=""

# Categories to sync
CATEGORIES=(skills agents commands runbooks)

# Determine source directory
get_source_dir() {
  if [[ -d "$HOME/.config/claude" ]]; then
    echo "$HOME/.config/claude"
  else
    echo "$HOME/.claude"
  fi
}

log_verbose() {
  if [[ "$VERBOSE" -eq 1 ]]; then
    echo "[DEBUG] $*" >&2
  fi
}

show_help() {
  echo "my-library-push v$VERSION - Push my-items from local to repo"
  echo ""
  echo "Usage:"
  echo "  my-library-push                          Push all my-items"
  echo "  my-library-push --dry-run                Show what would change without applying"
  echo "  my-library-push --verbose                Show detailed output"
  echo "  my-library-push --message \"custom msg\"   Custom commit message"
  echo "  my-library-push --only-skills            Push only skills"
  echo "  my-library-push --only-agents            Push only agents"
  echo "  my-library-push --only-commands          Push only commands"
  echo "  my-library-push --only-runbooks          Push only runbooks"
  echo "  my-library-push --version                Show version"
  echo "  my-library-push --help                   Show this help"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)       DRY_RUN=1; shift ;;
    --verbose)       VERBOSE=1; shift ;;
    --only-skills)   ONLY_SKILLS=1; shift ;;
    --only-agents)   ONLY_AGENTS=1; shift ;;
    --only-commands) ONLY_COMMANDS=1; shift ;;
    --only-runbooks) ONLY_RUNBOOKS=1; shift ;;
    --message)       COMMIT_MSG="$2"; shift 2 ;;
    -v|--version)    echo "my-library-push v$VERSION"; exit 0 ;;
    -h|--help)       show_help; exit 0 ;;
    *)               echo "Unknown option: $1"; show_help; exit 1 ;;
  esac
done

# Determine which categories to process
if [[ "$ONLY_SKILLS" -eq 1 ]] || [[ "$ONLY_AGENTS" -eq 1 ]] || [[ "$ONLY_COMMANDS" -eq 1 ]] || [[ "$ONLY_RUNBOOKS" -eq 1 ]]; then
  CATEGORIES=()
  [[ "$ONLY_SKILLS" -eq 1 ]] && CATEGORIES+=("skills")
  [[ "$ONLY_AGENTS" -eq 1 ]] && CATEGORIES+=("agents")
  [[ "$ONLY_COMMANDS" -eq 1 ]] && CATEGORIES+=("commands")
  [[ "$ONLY_RUNBOOKS" -eq 1 ]] && CATEGORIES+=("runbooks")
fi

SOURCE_DIR="$(get_source_dir)"
log_verbose "Source directory: $SOURCE_DIR"
log_verbose "Categories: ${CATEGORIES[*]}"

echo "my-library-push v$VERSION"
echo ""

# Step 1: Ensure repo clone exists
if [[ ! -d "$REPO_DIR/.git" ]]; then
  echo "ERROR: Repository not found at $REPO_DIR"
  echo "Run 'my-library-pull' first to clone the repository."
  exit 1
fi

# Step 2: Pull latest changes first (best-effort)
cd "$REPO_DIR"
echo "Syncing repository..."
if git diff --quiet && git diff --cached --quiet 2>/dev/null; then
  # Clean working tree — safe to pull
  if ! git pull --ff-only 2>/dev/null; then
    echo "WARNING: Fast-forward pull failed. Remote may have diverged."
    echo "         Resolve manually: cd $REPO_DIR && git status"
    exit 1
  fi
else
  # Uncommitted changes exist — try pull but don't fail
  log_verbose "Uncommitted changes detected, attempting pull..."
  if ! git pull --ff-only 2>/dev/null; then
    echo "NOTE: Skipping pull (uncommitted changes in repo). Push will proceed."
  fi
fi

# Ensure my/ directory structure exists
for category in "${CATEGORIES[@]}"; do
  mkdir -p "$REPO_DIR/my/$category"
done

# Step 3: Compare and sync each category
NEW_ITEMS=()
MODIFIED_ITEMS=()
DELETED_ITEMS=()
UNCHANGED_COUNT=0

for category in "${CATEGORIES[@]}"; do
  LOCAL_CAT_DIR="$SOURCE_DIR/$category"
  REPO_CAT_DIR="$REPO_DIR/my/$category"

  if [[ ! -d "$LOCAL_CAT_DIR" ]]; then
    log_verbose "No local $category directory, skipping"
    continue
  fi

  log_verbose "Processing category: $category"
  log_verbose "  Local: $LOCAL_CAT_DIR"
  log_verbose "  Repo:  $REPO_CAT_DIR"

  # Handle skills (directories with SKILL.md)
  if [[ "$category" == "skills" ]]; then
    # Find local my-* skill directories
    for item_dir in "$LOCAL_CAT_DIR"/my-*/; do
      [[ -d "$item_dir" ]] || continue
      item_name=$(basename "$item_dir")
      repo_item="$REPO_CAT_DIR/$item_name"

      if [[ ! -d "$repo_item" ]]; then
        echo "  + $category/$item_name (new)"
        NEW_ITEMS+=("$category/$item_name")
        if [[ "$DRY_RUN" -eq 0 ]]; then
          cp -r "$item_dir" "$repo_item"
        fi
      elif ! diff -rq "$item_dir" "$repo_item" > /dev/null 2>&1; then
        echo "  ~ $category/$item_name (modified)"
        MODIFIED_ITEMS+=("$category/$item_name")
        if [[ "$DRY_RUN" -eq 0 ]]; then
          rm -rf "$repo_item"
          cp -r "$item_dir" "$repo_item"
        fi
      else
        ((UNCHANGED_COUNT++)) || true
        log_verbose "  = $category/$item_name (unchanged)"
      fi
    done

    # Check for items in repo that no longer exist locally
    for repo_item_dir in "$REPO_CAT_DIR"/my-*/; do
      [[ -d "$repo_item_dir" ]] || continue
      item_name=$(basename "$repo_item_dir")
      local_item="$LOCAL_CAT_DIR/$item_name"

      if [[ ! -d "$local_item" ]]; then
        echo "  ! $category/$item_name (in repo but not local - NOT auto-deleted)"
        DELETED_ITEMS+=("$category/$item_name")
      fi
    done
  else
    # Handle agents, commands, runbooks (flat .md files)
    for item_file in "$LOCAL_CAT_DIR"/my-*.md; do
      [[ -f "$item_file" ]] || continue
      item_name=$(basename "$item_file")
      repo_item="$REPO_CAT_DIR/$item_name"

      if [[ ! -f "$repo_item" ]]; then
        echo "  + $category/$item_name (new)"
        NEW_ITEMS+=("$category/$item_name")
        if [[ "$DRY_RUN" -eq 0 ]]; then
          cp "$item_file" "$repo_item"
        fi
      elif ! diff -q "$item_file" "$repo_item" > /dev/null 2>&1; then
        echo "  ~ $category/$item_name (modified)"
        MODIFIED_ITEMS+=("$category/$item_name")
        if [[ "$DRY_RUN" -eq 0 ]]; then
          cp "$item_file" "$repo_item"
        fi
      else
        ((UNCHANGED_COUNT++)) || true
        log_verbose "  = $category/$item_name (unchanged)"
      fi
    done

    # Check for items in repo that no longer exist locally
    for repo_item_file in "$REPO_CAT_DIR"/my-*.md; do
      [[ -f "$repo_item_file" ]] || continue
      item_name=$(basename "$repo_item_file")
      local_item="$LOCAL_CAT_DIR/$item_name"

      if [[ ! -f "$local_item" ]]; then
        echo "  ! $category/$item_name (in repo but not local - NOT auto-deleted)"
        DELETED_ITEMS+=("$category/$item_name")
      fi
    done
  fi
done

# Summary
echo ""
TOTAL_CHANGES=$(( ${#NEW_ITEMS[@]} + ${#MODIFIED_ITEMS[@]} ))

if [[ "$DRY_RUN" -eq 1 ]]; then
  echo "DRY RUN - No changes made"
  echo "Would push: ${#NEW_ITEMS[@]} new, ${#MODIFIED_ITEMS[@]} modified, $UNCHANGED_COUNT unchanged"
  if [[ ${#DELETED_ITEMS[@]} -gt 0 ]]; then
    echo ""
    echo "Items in repo but missing locally (manual cleanup needed):"
    for d in "${DELETED_ITEMS[@]}"; do echo "  ! $d"; done
  fi
  exit 0
fi

if [[ "$TOTAL_CHANGES" -eq 0 ]]; then
  echo "Nothing to push ($UNCHANGED_COUNT items up to date)"
  exit 0
fi

# Step 4: Commit and push
cd "$REPO_DIR"

# Build commit message
if [[ -z "$COMMIT_MSG" ]]; then
  SUMMARY_PARTS=()
  [[ ${#NEW_ITEMS[@]} -gt 0 ]] && SUMMARY_PARTS+=("${#NEW_ITEMS[@]} new")
  [[ ${#MODIFIED_ITEMS[@]} -gt 0 ]] && SUMMARY_PARTS+=("${#MODIFIED_ITEMS[@]} modified")
  SUMMARY=$(IFS=', '; echo "${SUMMARY_PARTS[*]}")
  COMMIT_MSG="Update my-items: $SUMMARY"
fi

git add my/
git commit -m "$COMMIT_MSG"
git push

echo ""
echo "Pushed: ${#NEW_ITEMS[@]} new, ${#MODIFIED_ITEMS[@]} modified, $UNCHANGED_COUNT unchanged"

if [[ ${#DELETED_ITEMS[@]} -gt 0 ]]; then
  echo ""
  echo "Items in repo but missing locally (manual cleanup needed):"
  for d in "${DELETED_ITEMS[@]}"; do echo "  ! $d"; done
fi
