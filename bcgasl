#!/usr/bin/env bash
#
# bcgasl - Claude Global Agents & Skills Library
#
# Usage:
#   bcgasl                   Install/update agents & skills
#   bcgasl --n8n             Install/update with n8n skills
#   bcgasl --dry-run         Show what would change without applying
#   bcgasl --only-agents     Install only agents
#   bcgasl --only-skills     Install only skills
#   bcgasl --only-runbooks   Install only runbooks
#   bcgasl --only-templates  Install only templates
#   bcgasl --backup          Create backup before updating
#   bcgasl --uninstall       Remove all installed files
#   bcgasl --verbose         Show detailed debug output
#   bcgasl --version         Show version
#   bcgasl --help            Show this help

set -euo pipefail

VERSION="1.0.0"
TARBALL_URL="https://github.com/BPMspaceUG/bpm-claude-global-agent-skill-library/archive/refs/tags/v${VERSION}.tar.gz"
TARBALL_CHECKSUM="PLACEHOLDER_CHECKSUM_WILL_BE_UPDATED_AFTER_RELEASE"
EXTRACTED_DIR_NAME="bpm-claude-global-agent-skill-library-${VERSION}"

show_help() {
  echo "bcgasl - Claude Global Agents & Skills Library"
  echo ""
  echo "Usage:"
  echo "  bcgasl                   Install/update agents & skills"
  echo "  bcgasl --n8n             Install/update with n8n skills"
  echo "  bcgasl --dry-run         Show what would change without applying"
  echo "  bcgasl --only-agents     Install only agents"
  echo "  bcgasl --only-skills     Install only skills"
  echo "  bcgasl --only-runbooks   Install only runbooks"
  echo "  bcgasl --only-templates  Install only templates"
  echo "  bcgasl --backup          Create backup before updating"
  echo "  bcgasl --uninstall       Remove all installed files"
  echo "  bcgasl --verbose         Show detailed debug output"
  echo "  bcgasl --version         Show version"
  echo "  bcgasl --help            Show this help"
}

show_version() {
  echo "bcgasl v$VERSION"
}

compute_sha256() {
  local file="$1"
  if command -v sha256sum >/dev/null 2>&1; then
    sha256sum "$file" | cut -d' ' -f1
  elif command -v shasum >/dev/null 2>&1; then
    shasum -a 256 "$file" | cut -d' ' -f1
  else
    echo "ERROR: No sha256sum or shasum command found" >&2
    return 1
  fi
}

run_sync() {
  # Download tarball and extract sync script (bypasses CDN cache)
  TMP_DIR="$(mktemp -d)"
  trap 'rm -rf "$TMP_DIR"' EXIT

  TARBALL_FILE="$TMP_DIR/release.tar.gz"
  if ! curl -fsSL "$TARBALL_URL" -o "$TARBALL_FILE"; then
    echo "ERROR: Failed to download tarball" >&2
    exit 1
  fi

  # Verify checksum
  ACTUAL_CHECKSUM=$(compute_sha256 "$TARBALL_FILE") || exit 1
  if [[ "$ACTUAL_CHECKSUM" != "$TARBALL_CHECKSUM" ]]; then
    echo "ERROR: Checksum verification failed!" >&2
    echo "  Expected: $TARBALL_CHECKSUM" >&2
    echo "  Actual:   $ACTUAL_CHECKSUM" >&2
    exit 1
  fi

  tar -xzf "$TARBALL_FILE" -C "$TMP_DIR"
  bash "$TMP_DIR/${EXTRACTED_DIR_NAME}/sync" "$@"
}

# Collect flags to pass to sync
FLAGS=()
for arg in "$@"; do
  case "$arg" in
    -h|--help)
      show_help
      exit 0
      ;;
    -v|--version)
      show_version
      exit 0
      ;;
    --n8n|--dry-run|--backup|--uninstall|--verbose|--only-agents|--only-skills|--only-runbooks|--only-templates)
      FLAGS+=("$arg")
      ;;
    *)
      echo "Unknown option: $arg"
      show_help
      exit 1
      ;;
  esac
done

run_sync "${FLAGS[@]+"${FLAGS[@]}"}"
