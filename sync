#!/usr/bin/env bash
#
# Global Claude Agents & Skills installation script
#
# This script copies the contents of the `agents/`, `skills/`, `runbooks/` and
# `templates/` directories into the user's global Claude configuration
# directory. It supports an optional `--n8n` flag to also install the
# external n8n skills pack. The script may be invoked via
# `curl -fsSL <repo>/sync | bash`.

set -euo pipefail

# Trusted domains for downloads (security: only allow known hosts)
TRUSTED_DOMAINS=("github.com" "raw.githubusercontent.com")

REPO_TARBALL="https://github.com/BPMspaceUG/bpm-claude-global-agent-skill-library/archive/main.tar.gz"
N8N_TARBALL="https://github.com/czlonkowski/n8n-skills/archive/main.tar.gz"

# Security: Validate URL against trusted domains
validate_url() {
  local url="$1"
  local host

  # Extract host from URL
  if [[ "$url" =~ ^https://([^/]+)/ ]]; then
    host="${BASH_REMATCH[1]}"
  else
    echo "ERROR: Invalid URL format: $url" >&2
    return 1
  fi

  # Check if host is in trusted domains
  for domain in "${TRUSTED_DOMAINS[@]}"; do
    if [[ "$host" == "$domain" ]]; then
      return 0
    fi
  done

  echo "ERROR: Untrusted domain '$host' in URL: $url" >&2
  echo "Trusted domains: ${TRUSTED_DOMAINS[*]}" >&2
  return 1
}

# Security: Sanitize path to prevent directory traversal
sanitize_path() {
  local path="$1"
  # Remove any .. components and ensure path doesn't escape
  if [[ "$path" == *".."* ]]; then
    echo "ERROR: Path contains '..' (directory traversal): $path" >&2
    return 1
  fi
  # Ensure path starts with expected prefix
  echo "$path"
}

# Verbose logging helper
log_verbose() {
  if [ "$VERBOSE" -eq 1 ]; then
    echo "[DEBUG] $*" >&2
  fi
}

# Determine the target directory for Claude configuration
if [ -d "$HOME/.config/claude" ]; then
  TARGET_DIR="$HOME/.config/claude"
else
  TARGET_DIR="$HOME/.claude"
fi

# Parse arguments
INSTALL_N8N=0
DRY_RUN=0
BACKUP=0
UNINSTALL=0
VERBOSE=0
ONLY_AGENTS=0
ONLY_SKILLS=0
ONLY_RUNBOOKS=0
ONLY_TEMPLATES=0

for arg in "$@"; do
  case "$arg" in
    --n8n|--with-n8n)
      INSTALL_N8N=1
      ;;
    --dry-run)
      DRY_RUN=1
      ;;
    --backup)
      BACKUP=1
      ;;
    --uninstall)
      UNINSTALL=1
      ;;
    --verbose)
      VERBOSE=1
      ;;
    --only-agents)
      ONLY_AGENTS=1
      ;;
    --only-skills)
      ONLY_SKILLS=1
      ;;
    --only-runbooks)
      ONLY_RUNBOOKS=1
      ;;
    --only-templates)
      ONLY_TEMPLATES=1
      ;;
    *)
      ;;
  esac
done

log_verbose "Arguments parsed: dry_run=$DRY_RUN backup=$BACKUP uninstall=$UNINSTALL verbose=$VERBOSE n8n=$INSTALL_N8N"

# Determine which directories to process
if [ "$ONLY_AGENTS" -eq 1 ] || [ "$ONLY_SKILLS" -eq 1 ] || [ "$ONLY_RUNBOOKS" -eq 1 ] || [ "$ONLY_TEMPLATES" -eq 1 ]; then
  DIRS=()
  [ "$ONLY_AGENTS" -eq 1 ] && DIRS+=("agents")
  [ "$ONLY_SKILLS" -eq 1 ] && DIRS+=("skills")
  [ "$ONLY_RUNBOOKS" -eq 1 ] && DIRS+=("runbooks")
  [ "$ONLY_TEMPLATES" -eq 1 ] && DIRS+=("templates")
else
  DIRS=(agents skills runbooks templates)
fi

# Handle uninstall
if [ "$UNINSTALL" -eq 1 ]; then
  echo "Uninstalling bcgasl from $TARGET_DIR..."
  for dir in "${DIRS[@]}"; do
    if [ -d "$TARGET_DIR/$dir" ]; then
      if [ "$DRY_RUN" -eq 1 ]; then
        echo "   Would remove: $TARGET_DIR/$dir/"
      else
        rm -rf "${TARGET_DIR:?}/${dir:?}"
        echo "   Removed: $TARGET_DIR/$dir/"
      fi
    fi
  done
  if [ "$DRY_RUN" -eq 1 ]; then
    echo ""
    echo "DRY RUN - No changes made"
  else
    echo "âœ… Uninstalled successfully"
  fi
  exit 0
fi

# Ensure target subdirectories exist
for dir in "${DIRS[@]}"; do
  mkdir -p "$TARGET_DIR/$dir"
done

# Download and extract repo tarball
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

log_verbose "Created temp directory: $TMP_DIR"
log_verbose "Target directory: $TARGET_DIR"

# Validate URL before downloading
validate_url "$REPO_TARBALL" || exit 1

echo "Downloading BPMspace Claude Global Agents & Skills Library..."
log_verbose "Downloading from: $REPO_TARBALL"
curl -fsSL "$REPO_TARBALL" | tar -xz -C "$TMP_DIR"
EXTRACTED_DIR="$TMP_DIR/bpm-claude-global-agent-skill-library-main"

# Validate extracted directory exists
if [ ! -d "$EXTRACTED_DIR" ]; then
  echo "ERROR: Failed to extract tarball - expected directory not found" >&2
  exit 1
fi
log_verbose "Extracted to: $EXTRACTED_DIR"

# Compare and show changes
echo ""
# Create backup if requested
if [ "$BACKUP" -eq 1 ]; then
  BACKUP_DIR="$TARGET_DIR/backup-$(date +%Y-%m-%d-%H%M%S)"
  if [ "$DRY_RUN" -eq 1 ]; then
    echo "Would create backup at: $BACKUP_DIR"
  else
    mkdir -p "$BACKUP_DIR"
    for dir in "${DIRS[@]}"; do
      if [ -d "$TARGET_DIR/$dir" ] && [ "$(ls -A "$TARGET_DIR/$dir" 2>/dev/null)" ]; then
        cp -r "$TARGET_DIR/$dir" "$BACKUP_DIR/"
      fi
    done
    echo "ðŸ“¦ Backup created: $BACKUP_DIR"
  fi
  echo ""
fi

NEW_FILES=()
MODIFIED_FILES=()
LOCAL_ONLY=()
UNCHANGED=0

for dir in "${DIRS[@]}"; do
  # Check for new/modified from repo
  if [ -d "$EXTRACTED_DIR/$dir" ]; then
    for file in "$EXTRACTED_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")
      target_file="$TARGET_DIR/$dir/$filename"

      if [ ! -f "$target_file" ]; then
        NEW_FILES+=("$dir/$filename")
      elif ! diff -q "$file" "$target_file" > /dev/null 2>&1; then
        MODIFIED_FILES+=("$dir/$filename")
      else
        ((UNCHANGED++)) || true
      fi
    done
  fi

  # Check for local-only files (exist locally but not in repo)
  if [ -d "$TARGET_DIR/$dir" ]; then
    for file in "$TARGET_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")

      # Skip .zip files (artifacts)
      [[ "$filename" == *.zip ]] && continue

      repo_file="$EXTRACTED_DIR/$dir/$filename"

      if [ ! -f "$repo_file" ]; then
        LOCAL_ONLY+=("$dir/$filename")
      fi
    done
  fi
done

# Show results
if [ ${#NEW_FILES[@]} -gt 0 ]; then
  echo "ðŸ“¦ New files:"
  for f in "${NEW_FILES[@]}"; do echo "   + $f"; done
fi

if [ ${#MODIFIED_FILES[@]} -gt 0 ]; then
  echo "ðŸ“ Modified:"
  for f in "${MODIFIED_FILES[@]}"; do echo "   ~ $f"; done
fi

if [ ${#LOCAL_ONLY[@]} -gt 0 ]; then
  echo "ðŸ“ Local only (not in repo):"
  for f in "${LOCAL_ONLY[@]}"; do echo "   ? $f"; done
fi

if [ "$DRY_RUN" -eq 1 ]; then
  echo ""
  echo "DRY RUN - No changes will be made"
fi

if [ ${#NEW_FILES[@]} -eq 0 ] && [ ${#MODIFIED_FILES[@]} -eq 0 ]; then
  echo "âœ… Already up to date ($UNCHANGED files)"
elif [ "$DRY_RUN" -eq 1 ]; then
  echo "Would update: ${#NEW_FILES[@]} new, ${#MODIFIED_FILES[@]} modified, $UNCHANGED unchanged"
else
  # Actually copy the files
  echo ""
  echo "Installing into $TARGET_DIR..."
  for dir in "${DIRS[@]}"; do
    if [ -d "$EXTRACTED_DIR/$dir" ]; then
      cp -r "$EXTRACTED_DIR/$dir/." "$TARGET_DIR/$dir/"
    fi
  done
  echo "âœ… Updated: ${#NEW_FILES[@]} new, ${#MODIFIED_FILES[@]} modified, $UNCHANGED unchanged"
fi

# Optionally install the n8n skills pack (only if skills directory is being installed)
SKILLS_SELECTED=0
for d in "${DIRS[@]}"; do
  [ "$d" = "skills" ] && SKILLS_SELECTED=1
done

if [ "$INSTALL_N8N" -eq 1 ] && [ "$SKILLS_SELECTED" -eq 0 ]; then
  echo ""
  echo "âš ï¸  --n8n flag ignored: skills directory not selected for installation"
fi

if [ "$INSTALL_N8N" -eq 1 ] && [ "$SKILLS_SELECTED" -eq 1 ]; then
  echo ""
  # Validate n8n URL before downloading
  validate_url "$N8N_TARBALL" || exit 1

  echo "Downloading n8n-skills pack..."
  log_verbose "Downloading from: $N8N_TARBALL"
  curl -fsSL "$N8N_TARBALL" | tar -xz -C "$TMP_DIR"
  N8N_DIR="$TMP_DIR/n8n-skills-main"

  if [ ! -d "$N8N_DIR" ]; then
    echo "ERROR: Failed to extract n8n tarball - expected directory not found" >&2
    exit 1
  fi
  log_verbose "n8n extracted to: $N8N_DIR"

  # Determine source directory (prefer skills/ over dist/ to get raw .md files)
  if [ -d "$N8N_DIR/skills" ]; then
    N8N_SRC="$N8N_DIR/skills"
  elif [ -d "$N8N_DIR/dist" ]; then
    N8N_SRC="$N8N_DIR/dist"
  else
    echo "âš ï¸  n8n-skills: no skills or dist directory found"
    N8N_SRC=""
  fi

  # Compare n8n skills (directories)
  N8N_NEW=()
  N8N_MOD=()
  N8N_UNCH=0

  if [ -n "$N8N_SRC" ]; then
    for item in "$N8N_SRC"/*; do
      [ -e "$item" ] || continue
      itemname=$(basename "$item")

      # Skip .zip files
      [[ "$itemname" == *.zip ]] && continue

      target_item="$TARGET_DIR/skills/$itemname"

      if [ ! -e "$target_item" ]; then
        N8N_NEW+=("$itemname")
      elif [ -d "$item" ]; then
        # Compare directories by checking if any file differs
        if ! diff -rq "$item" "$target_item" > /dev/null 2>&1; then
          N8N_MOD+=("$itemname")
        else
          ((N8N_UNCH++)) || true
        fi
      elif [ -f "$item" ]; then
        if ! diff -q "$item" "$target_item" > /dev/null 2>&1; then
          N8N_MOD+=("$itemname")
        else
          ((N8N_UNCH++)) || true
        fi
      fi
    done
  fi

  # Show n8n results
  if [ ${#N8N_NEW[@]} -gt 0 ]; then
    echo "ðŸ“¦ n8n new:"
    for f in "${N8N_NEW[@]}"; do echo "   + $f"; done
  fi

  if [ ${#N8N_MOD[@]} -gt 0 ]; then
    echo "ðŸ“ n8n modified:"
    for f in "${N8N_MOD[@]}"; do echo "   ~ $f"; done
  fi

  if [ ${#N8N_NEW[@]} -eq 0 ] && [ ${#N8N_MOD[@]} -eq 0 ]; then
    echo "âœ… n8n skills already up to date ($N8N_UNCH items)"
  elif [ "$DRY_RUN" -eq 1 ]; then
    echo "Would update n8n: ${#N8N_NEW[@]} new, ${#N8N_MOD[@]} modified, $N8N_UNCH unchanged"
  else
    # Copy all items (files and directories, excluding .zip)
    for item in "$N8N_SRC"/*; do
      [ -e "$item" ] || continue
      [[ "$(basename "$item")" == *.zip ]] && continue
      cp -r "$item" "$TARGET_DIR/skills/"
    done
    echo "âœ… n8n updated: ${#N8N_NEW[@]} new, ${#N8N_MOD[@]} modified, $N8N_UNCH unchanged"
  fi
fi

# Cleanup: remove .zip artifacts from skills directory (skip in dry-run, only if skills are processed)
if [ "$DRY_RUN" -eq 0 ] && [ "$SKILLS_SELECTED" -eq 1 ]; then
  ZIP_COUNT=$(find "$TARGET_DIR/skills" -name "*.zip" 2>/dev/null | wc -l)
  if [ "$ZIP_COUNT" -gt 0 ]; then
    rm -f "$TARGET_DIR/skills"/*.zip
    echo "ðŸ§¹ Cleaned up $ZIP_COUNT .zip artifact(s)"
  fi
fi