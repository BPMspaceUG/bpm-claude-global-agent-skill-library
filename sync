#!/usr/bin/env bash
#
# Global Claude Agents & Skills installation script
#
# This script copies the contents of the `agents/`, `skills/`, `runbooks/` and
# `templates/` directories into the user's global Claude configuration
# directory. It supports an optional `--n8n` flag to also install the
# external n8n skills pack. The script may be invoked via
# `curl -fsSL <repo>/sync | bash`.

set -euo pipefail

REPO_TARBALL="https://github.com/BPMspaceUG/bpm-claude-global-agent-skill-library/archive/main.tar.gz"
N8N_TARBALL="https://github.com/czlonkowski/n8n-skills/archive/main.tar.gz"

# Determine the target directory for Claude configuration
if [ -d "$HOME/.config/claude" ]; then
  TARGET_DIR="$HOME/.config/claude"
else
  TARGET_DIR="$HOME/.claude"
fi

# Parse arguments
INSTALL_N8N=0
for arg in "$@"; do
  case "$arg" in
    --n8n|--with-n8n)
      INSTALL_N8N=1
      ;;
    *)
      ;;
  esac
done

# Ensure target subdirectories exist
mkdir -p "$TARGET_DIR"/{agents,skills,runbooks,templates}

# Download and extract repo tarball
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

echo "Downloading Claude Global Agents & Skills Library..."
curl -fsSL "$REPO_TARBALL" | tar -xz -C "$TMP_DIR"
EXTRACTED_DIR="$TMP_DIR/bpm-claude-global-agent-skill-library-main"

echo "Installing into $TARGET_DIR..."
cp -r "$EXTRACTED_DIR/agents/." "$TARGET_DIR/agents/"
cp -r "$EXTRACTED_DIR/skills/." "$TARGET_DIR/skills/"
cp -r "$EXTRACTED_DIR/runbooks/." "$TARGET_DIR/runbooks/"
cp -r "$EXTRACTED_DIR/templates/." "$TARGET_DIR/templates/"

# Optionally install the n8n skills pack
if [ "$INSTALL_N8N" -eq 1 ]; then
  echo "Downloading n8n-skills pack..."
  curl -fsSL "$N8N_TARBALL" | tar -xz -C "$TMP_DIR"
  N8N_DIR="$TMP_DIR/n8n-skills-main"
  if [ -d "$N8N_DIR/dist" ]; then
    cp -r "$N8N_DIR/dist/." "$TARGET_DIR/skills/"
  else
    cp -r "$N8N_DIR/skills/." "$TARGET_DIR/skills/"
  fi
fi

echo "Installation complete."

# Ask about aliases
echo ""
read -p "Add shell aliases (cgasl, cgasl-n8n)? [y/N] " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
  ALIAS_LINES='
# Claude Global Agents & Skills Library
alias cgasl="curl -fsSL https://raw.githubusercontent.com/BPMspaceUG/bpm-claude-global-agent-skill-library/main/sync | bash"
alias cgasl-n8n="curl -fsSL https://raw.githubusercontent.com/BPMspaceUG/bpm-claude-global-agent-skill-library/main/sync | bash -s -- --n8n"'

  # Detect shell and add to appropriate rc file
  if [ -f "$HOME/.zshrc" ]; then
    echo "$ALIAS_LINES" >> "$HOME/.zshrc"
    echo "Aliases added to ~/.zshrc - run 'source ~/.zshrc' or restart shell"
  elif [ -f "$HOME/.bashrc" ]; then
    echo "$ALIAS_LINES" >> "$HOME/.bashrc"
    echo "Aliases added to ~/.bashrc - run 'source ~/.bashrc' or restart shell"
  else
    echo "Could not detect shell config. Add manually:"
    echo "$ALIAS_LINES"
  fi
fi