#!/usr/bin/env bash
#
# Global Claude Agents & Skills installation script
#
# This script copies the contents of the `agents/`, `skills/`, `runbooks/` and
# `templates/` directories into the user's global Claude configuration
# directory. It supports an optional `--n8n` flag to also install the
# external n8n skills pack. The script may be invoked via
# `curl -fsSL <repo>/sync | bash`.

set -euo pipefail

REPO_TARBALL="https://github.com/BPMspaceUG/bpm-claude-global-agent-skill-library/archive/main.tar.gz"
N8N_TARBALL="https://github.com/czlonkowski/n8n-skills/archive/main.tar.gz"

# Determine the target directory for Claude configuration
if [ -d "$HOME/.config/claude" ]; then
  TARGET_DIR="$HOME/.config/claude"
else
  TARGET_DIR="$HOME/.claude"
fi

# Parse arguments
INSTALL_N8N=0
for arg in "$@"; do
  case "$arg" in
    --n8n|--with-n8n)
      INSTALL_N8N=1
      ;;
    *)
      ;;
  esac
done

# Ensure target subdirectories exist
mkdir -p "$TARGET_DIR"/{agents,skills,runbooks,templates}

# Download and extract repo tarball
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

echo "Downloading BPMspace Claude Global Agents & Skills Library..."
curl -fsSL "$REPO_TARBALL" | tar -xz -C "$TMP_DIR"
EXTRACTED_DIR="$TMP_DIR/bpm-claude-global-agent-skill-library-main"

# Compare and show changes
echo ""
NEW_FILES=()
MODIFIED_FILES=()
UNCHANGED=0

for dir in agents skills runbooks templates; do
  if [ -d "$EXTRACTED_DIR/$dir" ]; then
    for file in "$EXTRACTED_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")
      target_file="$TARGET_DIR/$dir/$filename"

      if [ ! -f "$target_file" ]; then
        NEW_FILES+=("$dir/$filename")
      elif ! diff -q "$file" "$target_file" > /dev/null 2>&1; then
        MODIFIED_FILES+=("$dir/$filename")
      else
        ((UNCHANGED++)) || true
      fi
    done
  fi
done

# Show results
if [ ${#NEW_FILES[@]} -gt 0 ]; then
  echo "üì¶ New files:"
  for f in "${NEW_FILES[@]}"; do echo "   + $f"; done
fi

if [ ${#MODIFIED_FILES[@]} -gt 0 ]; then
  echo "üìù Modified:"
  for f in "${MODIFIED_FILES[@]}"; do echo "   ~ $f"; done
fi

if [ ${#NEW_FILES[@]} -eq 0 ] && [ ${#MODIFIED_FILES[@]} -eq 0 ]; then
  echo "‚úÖ Already up to date ($UNCHANGED files)"
else
  # Actually copy the files
  echo ""
  echo "Installing into $TARGET_DIR..."
  cp -r "$EXTRACTED_DIR/agents/." "$TARGET_DIR/agents/"
  cp -r "$EXTRACTED_DIR/skills/." "$TARGET_DIR/skills/"
  cp -r "$EXTRACTED_DIR/runbooks/." "$TARGET_DIR/runbooks/"
  cp -r "$EXTRACTED_DIR/templates/." "$TARGET_DIR/templates/"
  echo "‚úÖ Updated: ${#NEW_FILES[@]} new, ${#MODIFIED_FILES[@]} modified, $UNCHANGED unchanged"
fi

# Optionally install the n8n skills pack
if [ "$INSTALL_N8N" -eq 1 ]; then
  echo ""
  echo "Downloading n8n-skills pack..."
  curl -fsSL "$N8N_TARBALL" | tar -xz -C "$TMP_DIR"
  N8N_DIR="$TMP_DIR/n8n-skills-main"
  if [ -d "$N8N_DIR/dist" ]; then
    cp -r "$N8N_DIR/dist/." "$TARGET_DIR/skills/"
  else
    cp -r "$N8N_DIR/skills/." "$TARGET_DIR/skills/"
  fi
  echo "‚úÖ n8n skills installed"
fi