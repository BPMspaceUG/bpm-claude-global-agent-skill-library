#!/usr/bin/env bash
#
# Global Claude Agents & Skills installation script
#
# This script copies the contents of the `agents/`, `skills/`, `runbooks/` and
# `templates/` directories into the user's global Claude configuration
# directory. It supports an optional `--n8n` flag to also install the
# external n8n skills pack. The script may be invoked via
# `curl -fsSL <repo>/sync | bash`.

set -euo pipefail

REPO_TARBALL="https://github.com/BPMspaceUG/bpm-claude-global-agent-skill-library/archive/main.tar.gz"
N8N_TARBALL="https://github.com/czlonkowski/n8n-skills/archive/main.tar.gz"

# Determine the target directory for Claude configuration
if [ -d "$HOME/.config/claude" ]; then
  TARGET_DIR="$HOME/.config/claude"
else
  TARGET_DIR="$HOME/.claude"
fi

# Parse arguments
INSTALL_N8N=0
for arg in "$@"; do
  case "$arg" in
    --n8n|--with-n8n)
      INSTALL_N8N=1
      ;;
    *)
      ;;
  esac
done

# Ensure target subdirectories exist
mkdir -p "$TARGET_DIR"/{agents,skills,runbooks,templates}

# Download and extract repo tarball
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

echo "Downloading BPMspace Claude Global Agents & Skills Library..."
curl -fsSL "$REPO_TARBALL" | tar -xz -C "$TMP_DIR"
EXTRACTED_DIR="$TMP_DIR/bpm-claude-global-agent-skill-library-main"

# Compare and show changes
echo ""
NEW_FILES=()
MODIFIED_FILES=()
LOCAL_ONLY=()
UNCHANGED=0

for dir in agents skills runbooks templates; do
  # Check for new/modified from repo
  if [ -d "$EXTRACTED_DIR/$dir" ]; then
    for file in "$EXTRACTED_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")
      target_file="$TARGET_DIR/$dir/$filename"

      if [ ! -f "$target_file" ]; then
        NEW_FILES+=("$dir/$filename")
      elif ! diff -q "$file" "$target_file" > /dev/null 2>&1; then
        MODIFIED_FILES+=("$dir/$filename")
      else
        ((UNCHANGED++)) || true
      fi
    done
  fi

  # Check for local-only files (exist locally but not in repo)
  if [ -d "$TARGET_DIR/$dir" ]; then
    for file in "$TARGET_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")

      # Skip .zip files (artifacts)
      [[ "$filename" == *.zip ]] && continue

      repo_file="$EXTRACTED_DIR/$dir/$filename"

      if [ ! -f "$repo_file" ]; then
        LOCAL_ONLY+=("$dir/$filename")
      fi
    done
  fi
done

# Show results
if [ ${#NEW_FILES[@]} -gt 0 ]; then
  echo "ðŸ“¦ New files:"
  for f in "${NEW_FILES[@]}"; do echo "   + $f"; done
fi

if [ ${#MODIFIED_FILES[@]} -gt 0 ]; then
  echo "ðŸ“ Modified:"
  for f in "${MODIFIED_FILES[@]}"; do echo "   ~ $f"; done
fi

if [ ${#LOCAL_ONLY[@]} -gt 0 ]; then
  echo "ðŸ“ Local only (not in repo):"
  for f in "${LOCAL_ONLY[@]}"; do echo "   ? $f"; done
fi

if [ ${#NEW_FILES[@]} -eq 0 ] && [ ${#MODIFIED_FILES[@]} -eq 0 ]; then
  echo "âœ… Already up to date ($UNCHANGED files)"
else
  # Actually copy the files
  echo ""
  echo "Installing into $TARGET_DIR..."
  cp -r "$EXTRACTED_DIR/agents/." "$TARGET_DIR/agents/"
  cp -r "$EXTRACTED_DIR/skills/." "$TARGET_DIR/skills/"
  cp -r "$EXTRACTED_DIR/runbooks/." "$TARGET_DIR/runbooks/"
  cp -r "$EXTRACTED_DIR/templates/." "$TARGET_DIR/templates/"
  echo "âœ… Updated: ${#NEW_FILES[@]} new, ${#MODIFIED_FILES[@]} modified, $UNCHANGED unchanged"
fi

# Optionally install the n8n skills pack
if [ "$INSTALL_N8N" -eq 1 ]; then
  echo ""
  echo "Downloading n8n-skills pack..."
  curl -fsSL "$N8N_TARBALL" | tar -xz -C "$TMP_DIR"
  N8N_DIR="$TMP_DIR/n8n-skills-main"

  # Determine source directory
  if [ -d "$N8N_DIR/dist" ]; then
    N8N_SRC="$N8N_DIR/dist"
  else
    N8N_SRC="$N8N_DIR/skills"
  fi

  # Compare n8n skills
  N8N_NEW=()
  N8N_MOD=()
  N8N_UNCH=0

  # Get list of n8n files from repo
  N8N_REPO_FILES=()
  for file in "$N8N_SRC"/*; do
    [ -f "$file" ] || continue
    filename=$(basename "$file")
    N8N_REPO_FILES+=("$filename")
    target_file="$TARGET_DIR/skills/$filename"

    if [ ! -f "$target_file" ]; then
      N8N_NEW+=("$filename")
    elif ! diff -q "$file" "$target_file" > /dev/null 2>&1; then
      N8N_MOD+=("$filename")
    else
      ((N8N_UNCH++)) || true
    fi
  done

  # Show n8n results
  if [ ${#N8N_NEW[@]} -gt 0 ]; then
    echo "ðŸ“¦ n8n new:"
    for f in "${N8N_NEW[@]}"; do echo "   + $f"; done
  fi

  if [ ${#N8N_MOD[@]} -gt 0 ]; then
    echo "ðŸ“ n8n modified:"
    for f in "${N8N_MOD[@]}"; do echo "   ~ $f"; done
  fi

  if [ ${#N8N_NEW[@]} -eq 0 ] && [ ${#N8N_MOD[@]} -eq 0 ]; then
    echo "âœ… n8n skills already up to date ($N8N_UNCH files)"
  else
    cp -r "$N8N_SRC/." "$TARGET_DIR/skills/"
    echo "âœ… n8n updated: ${#N8N_NEW[@]} new, ${#N8N_MOD[@]} modified, $N8N_UNCH unchanged"
  fi
fi

# Cleanup: remove .zip artifacts from skills directory
ZIP_COUNT=$(find "$TARGET_DIR/skills" -name "*.zip" 2>/dev/null | wc -l)
if [ "$ZIP_COUNT" -gt 0 ]; then
  rm -f "$TARGET_DIR/skills"/*.zip
  echo "ðŸ§¹ Cleaned up $ZIP_COUNT .zip artifact(s)"
fi