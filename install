#!/usr/bin/env bash
#
# Install bcgasl command for BPMspace Claude Global Agents & Skills Library
#
# Usage:
#   curl -fsSL .../install | bash              # Interactive
#   curl -fsSL .../install | bash -s -- --user   # User install
#   curl -fsSL .../install | bash -s -- --global # Global install (sudo)
#   curl -fsSL .../install | bash -s -- --all    # Both user and global
#   curl -fsSL .../install | bash -s -- --with-my-bpm-library  # Also install my-bpm-library-pull/push

set -euo pipefail

# Source shared library if available (may not exist during piped install)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/lib.sh" ]]; then
  # shellcheck source=lib.sh
  source "$SCRIPT_DIR/lib.sh"
  BCGASL_URL="${BCGASL_URL:-}"
else
  # Fallback for piped install (lib.sh not available)
  BCGASL_URL="https://raw.githubusercontent.com/BPMspaceUG/bpm-claude-global-agent-skill-library/main/bcgasl"
  TRUSTED_DOMAINS=("github.com" "raw.githubusercontent.com")

  validate_url() {
    local url="$1"
    local host
    if [[ -z "$url" ]]; then
      echo "ERROR: Empty URL provided" >&2
      return 1
    fi
    if [[ ! "$url" =~ ^https:// ]]; then
      echo "ERROR: URL must use HTTPS: $url" >&2
      return 1
    fi
    if [[ "$url" =~ ^https://([^/]+)/ ]]; then
      host="${BASH_REMATCH[1]}"
    else
      echo "ERROR: Invalid URL format: $url" >&2
      return 1
    fi
    for domain in "${TRUSTED_DOMAINS[@]}"; do
      if [[ "$host" == "$domain" ]]; then
        return 0
      fi
    done
    echo "ERROR: Untrusted domain '$host' in URL: $url" >&2
    return 1
  }
fi

USER_BIN="$HOME/.local/bin"
GLOBAL_BIN="/usr/local/bin"

# Parse arguments
CHOICE=""
INSTALL_ALL=0
INSTALL_MY_LIBRARY=0
for arg in "$@"; do
  case "$arg" in
    --user) CHOICE="1" ;;
    --global) CHOICE="2" ;;
    --all) INSTALL_ALL=1 ;;
    --with-my-bpm-library) INSTALL_MY_LIBRARY=1 ;;
  esac
done

# Install to user directory
install_user() {
  # Validate URL before downloading
  validate_url "$BCGASL_URL" || exit 1

  mkdir -p "$USER_BIN"
  curl -fsSL "$BCGASL_URL" -o "$USER_BIN/bcgasl"
  chmod +x "$USER_BIN/bcgasl"
  echo "Installed to $USER_BIN/bcgasl"

  # Check if ~/.local/bin is in PATH
  if [[ ":$PATH:" != *":$USER_BIN:"* ]]; then
    echo "NOTE: Add ~/.local/bin to your PATH:"
    echo "  echo 'export PATH=\"\$HOME/.local/bin:\$PATH\"' >> ~/.bashrc"
  fi
}

# Install to global directory
install_global() {
  # Validate URL before downloading
  validate_url "$BCGASL_URL" || exit 1

  echo "Installing globally (requires sudo)..."
  sudo curl -fsSL "$BCGASL_URL" -o "$GLOBAL_BIN/bcgasl"
  sudo chmod +x "$GLOBAL_BIN/bcgasl"
  echo "Installed to $GLOBAL_BIN/bcgasl"
}

# Handle --all flag
if [ "$INSTALL_ALL" -eq 1 ]; then
  echo "BPMspace Claude Global Agents & Skills Library - Install (all)"
  echo ""
  install_user
  echo ""
  install_global
# Interactive if no argument
elif [ -z "$CHOICE" ]; then
  echo "BPMspace Claude Global Agents & Skills Library - Install"
  echo ""
  echo "  [1] User install   - ~/.local/bin/bcgasl (current user only)"
  echo "  [2] Global install - /usr/local/bin/bcgasl (all users, requires sudo)"
  echo ""
  read -p "Choose [1/2]: " -n 1 -r </dev/tty 2>/dev/null || CHOICE="1"
  CHOICE="${REPLY:-1}"
  echo ""
  if [[ $CHOICE == "2" ]]; then
    install_global
  else
    install_user
  fi
elif [[ $CHOICE == "2" ]]; then
  install_global
else
  install_user
fi

# Install my-bpm-library-pull and my-bpm-library-push if requested
if [ "$INSTALL_MY_LIBRARY" -eq 1 ]; then
  echo ""
  echo "Installing my-bpm-library tools..."

  # Determine source: local repo or download
  if [[ -f "$SCRIPT_DIR/my-bpm-library-pull" ]] && [[ -f "$SCRIPT_DIR/my-bpm-library-push" ]]; then
    sudo cp "$SCRIPT_DIR/my-bpm-library-pull" "$GLOBAL_BIN/my-bpm-library-pull"
    sudo cp "$SCRIPT_DIR/my-bpm-library-push" "$GLOBAL_BIN/my-bpm-library-push"
  else
    MY_PULL_URL="https://raw.githubusercontent.com/BPMspaceUG/bpm-claude-global-agent-skill-library/main/my-bpm-library-pull"
    MY_PUSH_URL="https://raw.githubusercontent.com/BPMspaceUG/bpm-claude-global-agent-skill-library/main/my-bpm-library-push"
    validate_url "$MY_PULL_URL" || exit 1
    validate_url "$MY_PUSH_URL" || exit 1
    sudo curl -fsSL "$MY_PULL_URL" -o "$GLOBAL_BIN/my-bpm-library-pull"
    sudo curl -fsSL "$MY_PUSH_URL" -o "$GLOBAL_BIN/my-bpm-library-push"
  fi

  sudo chown root:root "$GLOBAL_BIN/my-bpm-library-pull" "$GLOBAL_BIN/my-bpm-library-push"
  sudo chmod +x "$GLOBAL_BIN/my-bpm-library-pull" "$GLOBAL_BIN/my-bpm-library-push"
  echo "Installed my-bpm-library-pull and my-bpm-library-push to $GLOBAL_BIN/"
fi

echo ""
echo "Usage:"
echo "  bcgasl                - Install/update agents & skills"
echo "  bcgasl --n8n          - Install/update with n8n skills"
echo "  bcgasl --help         - Show help"
if [ "$INSTALL_MY_LIBRARY" -eq 1 ]; then
  echo "  my-bpm-library-pull   - Pull my-bpm-items from repo to local"
  echo "  my-bpm-library-push   - Push my-bpm-items from local to repo"
fi
